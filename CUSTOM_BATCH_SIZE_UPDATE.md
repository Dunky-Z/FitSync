# 自定义批次大小功能更新说明

## 更新概述

本次更新为同步工具添加了完整的自定义批次大小功能，现在用户可以在历史迁移和增量同步模式下都能自定义处理的活动数量。

## 主要改进

### 1. 历史迁移模式增强
- ✅ **新增自定义批次大小选项**：用户现在可以选择"自定义批次大小"
- ✅ **扩大批次范围**：支持1-500个活动的自定义输入
- ✅ **保留原有选项**：调试模式(10)、正常模式(50)、快速模式(100)继续可用

### 2. 增量同步模式优化
- ✅ **保持现有功能**：自定义批次大小功能继续工作
- ✅ **合理的范围限制**：1-200个活动，适合增量同步场景

### 3. 输入验证增强
- ✅ **范围验证**：防止输入超出允许范围的数值
- ✅ **类型验证**：确保输入为有效数字
- ✅ **空值处理**：防止空输入导致的错误
- ✅ **错误提示**：输入无效时给出清晰的错误信息

## 使用方法

### 历史迁移模式
```
? 选择历史迁移的批次大小:
  调试模式 - 每次10个活动
  正常模式 - 每次50个活动
  快速模式 - 每次100个活动
❯ 自定义批次大小

? 请输入自定义批次大小 (1-500): 75
```

### 增量同步模式
```
? 选择增量同步的批次大小:
  小批次 - 每次10个活动
  中批次 - 每次30个活动
  大批次 - 每次50个活动
❯ 自定义批次大小

? 请输入自定义批次大小 (1-200): 25
```

## 批次大小建议

### 历史迁移模式（1-500）
- **小批次 (10-30)**：适合测试和调试
- **中批次 (50-100)**：推荐用于正常迁移
- **大批次 (100-500)**：适合大量数据快速迁移

### 增量同步模式（1-200）
- **小批次 (5-20)**：适合频繁同步
- **中批次 (20-50)**：适合日常使用
- **大批次 (50-200)**：适合离线后的批量同步

## 技术细节

### 代码修改
- 修改了 `src/main_sync.py` 中的 `select_batch_size()` 函数
- 为历史迁移模式添加了自定义批次大小选项
- 实现了完整的输入验证和错误处理

### 测试覆盖
- 创建了 `tests/test_custom_batch_size.py` 测试文件
- 测试了固定批次选择、自定义批次输入、输入验证等功能
- 所有测试用例均通过

## 性能考虑

### API限制
- **Strava API**：每天200次、每15分钟100次
- **IGPSport**：无明确限制，但建议适度使用
- **Garmin Connect**：无明确限制，但可能有反自动化检测

### 推荐策略
- **首次使用**：建议从小批次开始测试
- **API限制**：根据平台限制调整批次大小
- **网络条件**：网络不稳定时使用较小批次

## 向后兼容性

✅ **完全向后兼容**：现有的固定批次选项继续工作
✅ **配置保持**：不影响现有的同步配置
✅ **数据安全**：不影响已有的同步记录

## 使用示例

### 示例1：测试新功能
```bash
# 运行同步工具
python src/main_sync.py

# 选择增量同步 -> Strava to IGPSport -> 自定义批次大小 -> 输入15
```

### 示例2：大量历史迁移
```bash
# 选择历史迁移 -> Strava to IGPSport -> 自定义批次大小 -> 输入200
```

## 注意事项

1. **批次过大风险**：
   - 可能触发API限制
   - 网络中断时损失更多进度
   - 占用更多内存

2. **批次过小影响**：
   - 同步效率较低
   - 需要更多用户交互
   - 总体耗时增加

3. **推荐实践**：
   - 首次使用小批次测试
   - 根据网络和API状况调整
   - 定期检查同步状态

## 后续规划

- [ ] 添加批次大小自动调整功能
- [ ] 基于API限制动态推荐批次大小
- [ ] 添加批次大小性能统计
- [ ] 支持预设批次大小配置

---

**更新日期**：2024年1月
**版本**：v1.1.0
**兼容性**：完全向后兼容 